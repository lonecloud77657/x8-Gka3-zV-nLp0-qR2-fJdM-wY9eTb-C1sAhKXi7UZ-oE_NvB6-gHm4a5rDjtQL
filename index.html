<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¯æŠ½å¥–è½®ç›˜</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding-top: 30px; }
    canvas { border: 4px solid #333; border-radius: 50%; background: white; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    input[type="text"], input[type="number"] { padding: 6px; margin: 5px; }
    #result { font-size: 24px; margin-top: 20px; }
    #secretPanel { margin-top: 30px; }
    #controls {
      display: none; margin-top: 30px; background: #fff; padding: 20px;
      border: 1px solid #ccc; max-width: 600px; margin: 30px auto;
    }
    .entry { margin-bottom: 8px; }
    #totalDisplay { font-weight: bold; margin-bottom: 10px; color: #333; }
  </style>
</head>
<body>

  <h2>â¬‡</h2>
  <canvas id="wheel" width="500" height="500"></canvas><br>
  <button onclick="spin()">ğŸ° å¼€å§‹æŠ½å¥–</button>
  <button onclick="removeSelected()">ğŸ—‘ï¸ åˆ é™¤è¢«é€‰ä¸­é¡¹</button>
  <div id="result">ç»“æœï¼šå°šæœªæŠ½å¥–</div>

  <!-- ä¼ªè£…æœç´¢æ¡† -->
  <div id="secretPanel">
    <input id="secretInput" type="text" placeholder="ğŸ” æœç´¢..." style="border-radius: 20px;">
    <button onclick="checkPassword()">Search</button>
  </div>

  <!-- åå°è®¾ç½® -->
  <div id="controls">
    <h3>ğŸ›ï¸ ä¿®æ”¹æŠ½å¥–åå•ï¼ˆä»…åå°å¯è§æ¦‚ç‡%ï¼‰</h3>
    <div id="totalDisplay">æ€»å’Œï¼š100%</div>
    <div id="settings"></div>

    <input id="newNameInput" type="text" placeholder="è¾“å…¥å­¦å·-å§“å">
    <button onclick="addName()">â• æ·»åŠ </button>
    <button onclick="removeLast()">â– åˆ é™¤æœ€åä¸€ä¸ª</button>
    <button onclick="resetWeights()">ğŸ”„ Reset æ¦‚ç‡</button>
    <br><br>
    <button onclick="backToMain()">ğŸ”™ è¿”å›</button>
  </div>

  <script>
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const resultDiv = document.getElementById("result");
    const settingsDiv = document.getElementById("settings");
    const totalDisplay = document.getElementById("totalDisplay");

    let names = [];
    let angle = 0;
    let isSpinning = false;
    let lastSelectedIndex = null; // è®°å½•ä¸Šæ¬¡æŠ½ä¸­çš„äºº

    function init() {
      names = [
        { name: "è€ƒè¯•ä½œå¼Š", weight: 12.5 },
        { name: "å¿˜è®°åšåŠŸè¯¾", weight: 12.5 },
        { name: "ä¸Šè¯¾å·åƒä¸œè¥¿", weight: 12.5 },
        { name: "å¿˜è®°å¸¦æ™ºèƒ½å¡", weight: 12.5 },
        { name: "æ”¶åˆ°ä¸€å°æƒ…ä¹¦", weight: 12.5 },
        { name: "æ ¡åº†å¸ƒç½®", weight: 12.5 },
        { name: "æ”¹è¿‡è¿å–„", weight: 12.5 },
        { name: "æ—©è‡ªä¹ ", weight: 12.5 },

      ];
      normalizeWeights();
      renderSettings();
      drawWheel();
    }

    function renderSettings() {
      settingsDiv.innerHTML = "";
      names.forEach((entry, i) => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          åå­—ï¼š
          <input type="text" value="${entry.name}" onchange="updateName(${i}, this.value)">
          æ¦‚ç‡(%)ï¼š
          <input type="number" value="${entry.weight.toFixed(2)}" min="0" max="100" step="0.01" onchange="updateWeight(${i}, this.value)">
        `;
        settingsDiv.appendChild(div);
      });
      updateTotalDisplay();
    }

    function updateName(index, value) {
      names[index].name = value.trim() || `æ¡ç›® ${index + 1}`;
      drawWheel();
    }

    function updateWeight(index, value) {
      let val = parseFloat(value);
      if (!isNaN(val) && val >= 0 && val <= 100) {
        names[index].weight = val;
        normalizeWeights();
        renderSettings();
        drawWheel();
      } else {
        alert("è¯·è¾“å…¥ 0-100 ä¹‹é—´çš„ç™¾åˆ†æ¯”");
      }
    }

    function normalizeWeights() {
      let total = names.reduce((sum, n) => sum + n.weight, 0);
      if (total === 0) {
        let avg = 100 / names.length;
        names.forEach(n => n.weight = avg);
      } else {
        names.forEach(n => n.weight = (n.weight / total) * 100);
      }
    }

    function updateTotalDisplay() {
      let total = names.reduce((sum, n) => sum + n.weight, 0);
      totalDisplay.textContent = "æ€»å’Œï¼š" + total.toFixed(2) + "%";
    }

    function addName() {
      const input = document.getElementById("newNameInput");
      const value = input.value.trim();
      if (!value) {
        alert("è¯·è¾“å…¥å­¦å·-å§“å");
        return;
      }
      names.push({ name: value, weight: 0 });
      normalizeWeights();
      input.value = "";
      renderSettings();
      drawWheel();
    }

    function removeLast() {
      if (names.length <= 2) return alert("è‡³å°‘ä¿ç•™ä¸¤ä¸ªé¡¹");
      names.pop();
      normalizeWeights();
      renderSettings();
      drawWheel();
    }

    function resetWeights() {
      let avg = 100 / names.length;
      names.forEach(n => n.weight = avg);
      renderSettings();
      drawWheel();
    }

    function drawWheel() {
      const total = names.length;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 240;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let start = angle;
      for (let i = 0; i < total; i++) {
        const sliceAngle = 2 * Math.PI / total; // å‡åˆ†æ˜¾ç¤º
        const endAngle = start + sliceAngle;

        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, start, endAngle);
        ctx.fillStyle = `hsl(${(i * 360) / total}, 70%, 70%)`;
        ctx.fill();
        ctx.stroke();

        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate((start + endAngle) / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "14px sans-serif";
        ctx.fillText(names[i].name, radius - 10, 5);
        ctx.restore();

        start = endAngle;
      }

      // ä¸­å¿ƒåœ†
      ctx.beginPath();
      ctx.arc(centerX, centerY, 40, 0, 2 * Math.PI);
      ctx.fillStyle = "#fff";
      ctx.fill();
      ctx.stroke();

      // ç®­å¤´æŒ‡é’ˆï¼ˆé¡¶éƒ¨å›ºå®šï¼‰
      ctx.beginPath();
      ctx.moveTo(centerX - 20, centerY - radius - 10);
      ctx.lineTo(centerX + 20, centerY - radius - 10);
      ctx.lineTo(centerX, centerY - radius - 50);
      ctx.closePath();
      ctx.fillStyle = "red";
      ctx.fill();
      ctx.stroke();
    }

    function spin() {
      if (isSpinning) return;
      if (names.length === 0) {
        resultDiv.textContent = "âš ï¸ æ²¡æœ‰å¯æŠ½çš„äººäº†ï¼";
        return;
      }
      isSpinning = true;
      resultDiv.textContent = "ğŸ² æ­£åœ¨æ—‹è½¬...";

      let rand = Math.random() * 100;
      let selectedIndex = 0;
      for (let i = 0; i < names.length; i++) {
        rand -= names[i].weight;
        if (rand <= 0) {
          selectedIndex = i;
          break;
        }
      }

      const sliceAngle = 2 * Math.PI / names.length;
      const stopAngle = (3 * Math.PI / 2) - (selectedIndex * sliceAngle) - (sliceAngle / 2);
      const extraSpins = 5 * 2 * Math.PI;
      const targetAngle = extraSpins + stopAngle;

      let startTime = performance.now();
      function animate(time) {
        const progress = Math.min((time - startTime) / 4000, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        angle = targetAngle * easeOut;
        drawWheel();
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false;
          lastSelectedIndex = selectedIndex; // è®°å½•æŠ½ä¸­äºº
          resultDiv.textContent = `ğŸ‰ æŠ½ä¸­ï¼š${names[selectedIndex].name}ï¼`;
        }
      }

      requestAnimationFrame(animate);
    }

    function removeSelected() {
      if (lastSelectedIndex === null) {
        alert("âš ï¸ è¯·å…ˆæŠ½å¥–ï¼");
        return;
      }
      names.splice(lastSelectedIndex, 1);
      lastSelectedIndex = null;
      if (names.length > 0) {
        normalizeWeights();
        renderSettings();
        drawWheel();
        resultDiv.textContent += "ï¼ˆå·²åˆ é™¤ï¼‰";
      } else {
        resultDiv.textContent = "âš ï¸ æ‰€æœ‰äººéƒ½å·²åˆ é™¤ï¼";
      }
    }

    function checkPassword() {
      const pwd = document.getElementById("secretInput").value;
      if (pwd === "8888") {
        document.getElementById("controls").style.display = "block";
        document.getElementById("secretPanel").style.display = "none";
      } else {
        alert("æ— ç»“æœ");
      }
    }

    function backToMain() {
      document.getElementById("controls").style.display = "none";
      document.getElementById("secretPanel").style.display = "block";
      document.getElementById("secretInput").value = "";
    }

    init();
  </script>
</body>
</html>
