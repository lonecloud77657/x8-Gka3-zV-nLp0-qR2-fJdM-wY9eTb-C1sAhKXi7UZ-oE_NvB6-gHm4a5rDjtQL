<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>🎯抽奖轮盘</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding-top: 30px; }
    canvas { border: 4px solid #333; border-radius: 50%; background: white; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    input[type="text"], input[type="number"] { padding: 6px; margin: 5px; }
    #result { font-size: 24px; margin-top: 20px; }
    #secretPanel { margin-top: 30px; }
    #controls {
      display: none; margin-top: 30px; background: #fff; padding: 20px;
      border: 1px solid #ccc; max-width: 600px; margin: 30px auto;
    }
    .entry { margin-bottom: 8px; }
    #totalDisplay { font-weight: bold; margin-bottom: 10px; color: #333; }
  </style>
</head>
<body>

  <h2>⬇</h2>
  <canvas id="wheel" width="500" height="500"></canvas><br>
  <button onclick="spin()">🎰 开始抽奖</button>
  <button onclick="removeSelected()">🗑️ 删除被选中项</button>
  <div id="result">结果：尚未抽奖</div>

  <!-- 伪装搜索框 -->
  <div id="secretPanel">
    <input id="secretInput" type="text" placeholder="🔍 搜索..." style="border-radius: 20px;">
    <button onclick="checkPassword()">Search</button>
  </div>

  <!-- 后台设置 -->
  <div id="controls">
    <h3>🎛️ 修改抽奖名单（仅后台可见概率%）</h3>
    <div id="totalDisplay">总和：100%</div>
    <div id="settings"></div>

    <input id="newNameInput" type="text" placeholder="输入学号-姓名">
    <button onclick="addName()">➕ 添加</button>
    <button onclick="removeLast()">➖ 删除最后一个</button>
    <button onclick="resetWeights()">🔄 Reset 概率</button>
    <br><br>
    <button onclick="backToMain()">🔙 返回</button>
  </div>

  <script>
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const resultDiv = document.getElementById("result");
    const settingsDiv = document.getElementById("settings");
    const totalDisplay = document.getElementById("totalDisplay");

    let names = [];
    let angle = 0;
    let isSpinning = false;
    let lastSelectedIndex = null; // 记录上次抽中的人

    function init() {
      names = [
        { name: "考试作弊", weight: 12.5 },
        { name: "忘记做功课", weight: 12.5 },
        { name: "上课偷吃东西", weight: 12.5 },
        { name: "忘记带智能卡", weight: 12.5 },
        { name: "收到一封情书", weight: 12.5 },
        { name: "校庆布置", weight: 12.5 },
        { name: "改过迁善", weight: 12.5 },
        { name: "早自习", weight: 12.5 },

      ];
      normalizeWeights();
      renderSettings();
      drawWheel();
    }

    function renderSettings() {
      settingsDiv.innerHTML = "";
      names.forEach((entry, i) => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          名字：
          <input type="text" value="${entry.name}" onchange="updateName(${i}, this.value)">
          概率(%)：
          <input type="number" value="${entry.weight.toFixed(2)}" min="0" max="100" step="0.01" onchange="updateWeight(${i}, this.value)">
        `;
        settingsDiv.appendChild(div);
      });
      updateTotalDisplay();
    }

    function updateName(index, value) {
      names[index].name = value.trim() || `条目 ${index + 1}`;
      drawWheel();
    }

    function updateWeight(index, value) {
      let val = parseFloat(value);
      if (!isNaN(val) && val >= 0 && val <= 100) {
        names[index].weight = val;
        normalizeWeights();
        renderSettings();
        drawWheel();
      } else {
        alert("请输入 0-100 之间的百分比");
      }
    }

    function normalizeWeights() {
      let total = names.reduce((sum, n) => sum + n.weight, 0);
      if (total === 0) {
        let avg = 100 / names.length;
        names.forEach(n => n.weight = avg);
      } else {
        names.forEach(n => n.weight = (n.weight / total) * 100);
      }
    }

    function updateTotalDisplay() {
      let total = names.reduce((sum, n) => sum + n.weight, 0);
      totalDisplay.textContent = "总和：" + total.toFixed(2) + "%";
    }

    function addName() {
      const input = document.getElementById("newNameInput");
      const value = input.value.trim();
      if (!value) {
        alert("请输入学号-姓名");
        return;
      }
      names.push({ name: value, weight: 0 });
      normalizeWeights();
      input.value = "";
      renderSettings();
      drawWheel();
    }

    function removeLast() {
      if (names.length <= 2) return alert("至少保留两个项");
      names.pop();
      normalizeWeights();
      renderSettings();
      drawWheel();
    }

    function resetWeights() {
      let avg = 100 / names.length;
      names.forEach(n => n.weight = avg);
      renderSettings();
      drawWheel();
    }

    function drawWheel() {
      const total = names.length;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = 240;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let start = angle;
      for (let i = 0; i < total; i++) {
        const sliceAngle = 2 * Math.PI / total; // 均分显示
        const endAngle = start + sliceAngle;

        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, start, endAngle);
        ctx.fillStyle = `hsl(${(i * 360) / total}, 70%, 70%)`;
        ctx.fill();
        ctx.stroke();

        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate((start + endAngle) / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "14px sans-serif";
        ctx.fillText(names[i].name, radius - 10, 5);
        ctx.restore();

        start = endAngle;
      }

      // 中心圆
      ctx.beginPath();
      ctx.arc(centerX, centerY, 40, 0, 2 * Math.PI);
      ctx.fillStyle = "#fff";
      ctx.fill();
      ctx.stroke();

      // 箭头指针（顶部固定）
      ctx.beginPath();
      ctx.moveTo(centerX - 20, centerY - radius - 10);
      ctx.lineTo(centerX + 20, centerY - radius - 10);
      ctx.lineTo(centerX, centerY - radius - 50);
      ctx.closePath();
      ctx.fillStyle = "red";
      ctx.fill();
      ctx.stroke();
    }

    function spin() {
      if (isSpinning) return;
      if (names.length === 0) {
        resultDiv.textContent = "⚠️ 没有可抽的人了！";
        return;
      }
      isSpinning = true;
      resultDiv.textContent = "🎲 正在旋转...";

      let rand = Math.random() * 100;
      let selectedIndex = 0;
      for (let i = 0; i < names.length; i++) {
        rand -= names[i].weight;
        if (rand <= 0) {
          selectedIndex = i;
          break;
        }
      }

      const sliceAngle = 2 * Math.PI / names.length;
      const stopAngle = (3 * Math.PI / 2) - (selectedIndex * sliceAngle) - (sliceAngle / 2);
      const extraSpins = 5 * 2 * Math.PI;
      const targetAngle = extraSpins + stopAngle;

      let startTime = performance.now();
      function animate(time) {
        const progress = Math.min((time - startTime) / 4000, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        angle = targetAngle * easeOut;
        drawWheel();
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false;
          lastSelectedIndex = selectedIndex; // 记录抽中人
          resultDiv.textContent = `🎉 抽中：${names[selectedIndex].name}！`;
        }
      }

      requestAnimationFrame(animate);
    }

    function removeSelected() {
      if (lastSelectedIndex === null) {
        alert("⚠️ 请先抽奖！");
        return;
      }
      names.splice(lastSelectedIndex, 1);
      lastSelectedIndex = null;
      if (names.length > 0) {
        normalizeWeights();
        renderSettings();
        drawWheel();
        resultDiv.textContent += "（已删除）";
      } else {
        resultDiv.textContent = "⚠️ 所有人都已删除！";
      }
    }

    function checkPassword() {
      const pwd = document.getElementById("secretInput").value;
      if (pwd === "8888") {
        document.getElementById("controls").style.display = "block";
        document.getElementById("secretPanel").style.display = "none";
      } else {
        alert("无结果");
      }
    }

    function backToMain() {
      document.getElementById("controls").style.display = "none";
      document.getElementById("secretPanel").style.display = "block";
      document.getElementById("secretInput").value = "";
    }

    init();
  </script>
</body>
</html>
